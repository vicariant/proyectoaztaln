<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTC COMMAND: DECODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@400;600&family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --gold: #ffd700; --orange: #ff6b35; --dark: #050810; --panel: rgba(15, 20, 30, 0.95);
            --font-tech: 'Orbitron', sans-serif; --font-body: 'Rajdhani', sans-serif;
        }
        body { margin: 0; background: var(--dark); color: #eee; font-family: var(--font-body); overflow: hidden; height: 100vh; }
        
        /* FONDO */
        .bg { position: fixed; width: 100%; height: 100%; background: url('https://www.transparenttextures.com/patterns/sand-dust.png'), radial-gradient(circle, #1a1a1a 0%, #000 90%); opacity: 0.5; z-index: -1; animation: drift 60s linear infinite; }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 100px 100px; } }

        /* HEADER */
        header { padding: 15px 30px; border-bottom: 2px solid var(--gold); background: rgba(0,0,0,0.9); display: flex; justify-content: space-between; align-items: center; }
        .title { font-family: var(--font-tech); color: var(--gold); font-size: 1.4em; letter-spacing: 2px; }
        .back { border: 1px solid var(--gold); color: var(--gold); padding: 5px 15px; text-decoration: none; font-family: var(--font-tech); font-size: 0.8em; transition: 0.3s; }
        .back:hover { background: var(--gold); color: #000; }

        /* GRID */
        .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; height: calc(100vh - 80px); }
        .panel { background: var(--panel); border: 1px solid #444; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .head { background: rgba(255, 215, 0, 0.1); padding: 10px 15px; color: var(--gold); font-family: var(--font-tech); border-bottom: 1px solid #444; }

        /* TABLA PERSONALIZADA (ESTO REEMPLAZA AL IFRAME) */
        .custom-table { width: 100%; border-collapse: collapse; }
        .custom-table th { text-align: left; padding: 12px; color: var(--orange); border-bottom: 2px solid var(--orange); font-family: var(--font-tech); font-size: 0.9em; }
        .custom-table td { padding: 12px; border-bottom: 1px solid #333; color: #ccc; }
        .custom-table tr:hover { background: rgba(255, 215, 0, 0.05); }
        .status-live { color: #0f0; font-weight: bold; text-shadow: 0 0 5px #0f0; }
        .status-soon { color: #aaa; font-style: italic; }

        /* CHAT & GAME */
        .chat-area { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.9em; }
        .chat-in { background: #000; border: 1px solid var(--gold); color: #fff; width: 100%; padding: 10px; }
        .ai-msg { border-left: 2px solid var(--gold); padding-left: 10px; color: var(--gold); margin: 5px 0; }
        
        /* BUSCAMINAS SIMPLE */
        .game-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; width: fit-content; margin: 10px auto; border: 1px solid var(--orange); padding: 5px; }
        .cell { width: 25px; height: 25px; background: #222; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 1px solid #333; }
        .cell:hover { background: #333; }
        .cell.trap { background: var(--orange); }
        .cell.safe { background: #111; color: var(--gold); }
    </style>
</head>
<body>
    <div class="bg"></div>
    <header>
        <div class="title"><i class="fas fa-satellite-dish"></i> FTC DECODE // LIVE</div>
        <a href="/" class="back">SALIR</a>
    </header>

    <div class="layout">
        <div class="panel">
            <div class="head">
                <i class="fas fa-list"></i> TORNEOS ACTIVOS (M√âXICO)
                <button onclick="loadEvents()" style="float:right; background:transparent; border:none; color:var(--gold); cursor:pointer;"><i class="fas fa-sync"></i></button>
            </div>
            <div style="overflow-y: auto; padding: 0;">
                <div id="loader" style="padding:20px; text-align:center; color:var(--orange);">üì° Escaneando servidores de FIRST...</div>
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>ESTADO</th>
                            <th>NOMBRE DEL EVENTO</th>
                            <th>UBICACI√ìN</th>
                            <th>FECHA</th>
                        </tr>
                    </thead>
                    <tbody id="events-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="panel" style="height:50%;">
                <div class="head"><i class="fas fa-robot"></i> JUEZ IA</div>
                <div class="chat-area" id="chat-box"><div class="ai-msg">Soy un Juez imparcial. ¬øDudas del reglamento?</div></div>
                <input class="chat-in" id="chat-input" placeholder="Pregunta aqu√≠..." onkeypress="if(event.key==='Enter') sendChat()">
            </div>
            
            <div class="panel" style="flex:1; border-color:var(--orange);">
                <div class="head" style="color:var(--orange);"><i class="fas fa-bomb"></i> EXCAVACI√ìN</div>
                <div style="text-align:center; padding:10px;">
                    <div id="grid" class="game-grid"></div>
                    <div id="status" style="color:var(--gold); font-weight:bold;">SEGURO</div>
                    <button onclick="initGame()" style="background:none; border:1px solid #555; color:#aaa; margin-top:5px; cursor:pointer;">REINICIAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CARGAR DATOS (EXTRAER Y PINTAR TABLA) ---
        window.onload = () => { loadEvents(); initGame(); };

        async function loadEvents() {
            const tbody = document.getElementById('events-body');
            const loader = document.getElementById('loader');
            tbody.innerHTML = ''; 
            loader.style.display = 'block';

            try {
                // Llamamos a TU servidor para que √©l haga el trabajo sucio
                const res = await fetch('/api/ftc-live-scrape');
                const json = await res.json();
                
                loader.style.display = 'none';
                
                // Dibujamos la tabla fila por fila
                json.data.forEach(ev => {
                    const row = document.createElement('tr');
                    const isLive = ev.status.includes("VIVO") || ev.status.includes("En Curso");
                    
                    row.innerHTML = `
                        <td class="${isLive ? 'status-live' : 'status-soon'}">
                            ${isLive ? '‚óè EN VIVO' : '‚óã ' + ev.status}
                        </td>
                        <td style="font-weight:bold; color:#fff;">${ev.name}</td>
                        <td>${ev.location}</td>
                        <td>${ev.date}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch(e) {
                loader.innerText = "Error de conexi√≥n satelital.";
            }
        }

        // --- 2. CHATBOT ---
        async function sendChat() {
            const inp = document.getElementById('chat-input');
            const txt = inp.value; if(!txt)return;
            const box = document.getElementById('chat-box');
            
            box.innerHTML += `<div style="text-align:right; color:#aaa; margin:5px 0;">${txt}</div>`;
            inp.value = '';
            
            const r = await fetch('/api/nasa-rag', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_query:txt, lang:'es', mode:'ftc'})
            });
            const d = await r.json();
            box.innerHTML += `<div class="ai-msg">${d.answer}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- 3. JUEGO ---
        const size=8, mines=8; let board=[]; 
        function initGame() {
            const g=document.getElementById('grid'); g.innerHTML='';
            board=Array(size).fill().map(()=>Array(size).fill(0));
            // Generar minas simples
            let m=0; while(m<mines){ let r=Math.floor(Math.random()*size),c=Math.floor(Math.random()*size); if(board[r][c]!==9){board[r][c]=9;m++;}}
            // Dibujar
            for(let r=0;r<size;r++) for(let c=0;c<size;c++){
                let d=document.createElement('div'); d.className='cell';
                d.onclick=()=>{
                    if(board[r][c]===9){ d.className='cell trap'; document.getElementById('status').innerText="¬°FALLO!"; }
                    else { d.className='cell safe'; d.innerText='‚Ä¢'; }
                };
                g.appendChild(d);
            }
            document.getElementById('status').innerText="SEGURO";
        }
    </script>
</body>
</html>
