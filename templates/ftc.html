<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTC DECODE Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Rajdhani',sans-serif;background:linear-gradient(135deg,#050505 0%,#1a1a2e 100%);color:#e0e0e0;min-height:100vh}
        .container{max-width:1600px;margin:0 auto;padding:20px}
        header{text-align:center;padding:30px 0;background:linear-gradient(90deg,rgba(255,215,0,.1) 0%,rgba(255,107,53,.1) 100%);border-bottom:3px solid #ffd700;margin-bottom:30px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,215,0,.3),transparent);animation:scan 3s infinite}
        @keyframes scan{0%{left:-100%}100%{left:100%}}
        h1{font-family:'Orbitron',monospace;font-size:3em;font-weight:900;background:linear-gradient(45deg,#ffd700,#ff6b35);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .subtitle{font-size:1.2em;color:#ff6b35;margin-top:10px;letter-spacing:3px}
        .main-grid{display:grid;grid-template-columns:1fr 350px;gap:20px;margin-bottom:30px}
        .data-section,.game-panel,.chatbot-section{background:rgba(26,26,46,.8);border:2px solid #ffd700;border-radius:15px;padding:20px;box-shadow:0 0 30px rgba(255,215,0,.2)}
        .game-panel{border-color:#ff6b35;box-shadow:0 0 30px rgba(255,107,53,.2)}
        .tabs{display:flex;gap:10px;margin-bottom:20px}
        .tab-btn{flex:1;padding:15px;background:rgba(255,215,0,.1);border:2px solid #ffd700;color:#ffd700;font-family:'Orbitron',monospace;cursor:pointer;transition:all .3s;border-radius:8px}
        .tab-btn:hover{background:rgba(255,215,0,.3);transform:translateY(-2px)}
        .tab-btn.active{background:#ffd700;color:#050505;box-shadow:0 0 20px rgba(255,215,0,.5)}
        .tab-content{display:none}
        .tab-content.active{display:block;animation:fadeIn .5s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th{background:linear-gradient(135deg,#ffd700 0%,#ff6b35 100%);color:#050505;padding:15px;text-align:left;font-family:'Orbitron',monospace;font-weight:700}
        td{padding:12px 15px;border-bottom:1px solid rgba(255,215,0,.2);transition:all .3s}
        tr:hover{background:rgba(255,107,53,.1);cursor:pointer}
        .game-title,.chatbot-title{font-family:'Orbitron',monospace;font-size:1.3em;margin-bottom:15px;text-align:center}
        .game-title{color:#ff6b35;font-size:1.5em}
        .chatbot-title{color:#ffd700}
        .game-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin:20px 0}
        .game-cell{aspect-ratio:1;background:rgba(255,215,0,.1);border:1px solid #ffd700;display:flex;align-items:center;justify-content:center;font-size:1.2em;cursor:pointer;transition:all .2s;border-radius:4px}
        .game-cell:hover{background:rgba(255,215,0,.3);transform:scale(1.1)}
        .game-cell.revealed{background:rgba(100,100,100,.5);cursor:default}
        .game-cell.mine{background:rgba(255,0,0,.5)}
        .game-stats{display:flex;justify-content:space-between;margin-top:15px;padding:10px;background:rgba(255,215,0,.1);border-radius:8px}
        .stat-item{text-align:center}
        .stat-label{font-size:.8em;color:#ff6b35}
        .stat-value{font-size:1.5em;font-weight:700;color:#ffd700}
        .game-btn{width:100%;padding:12px;background:linear-gradient(135deg,#ff6b35 0%,#ffd700 100%);border:none;color:#050505;font-family:'Orbitron',monospace;font-weight:700;cursor:pointer;border-radius:8px;margin-top:10px;transition:all .3s}
        .game-btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(255,107,53,.5)}
        .chatbot-section{margin-top:20px}
        .chat-messages{height:200px;overflow-y:auto;background:rgba(0,0,0,.3);border:1px solid #ffd700;border-radius:8px;padding:10px;margin-bottom:10px}
        .chat-message{margin-bottom:10px;padding:8px;border-radius:5px}
        .user-message{background:rgba(255,107,53,.2);text-align:right}
        .bot-message{background:rgba(255,215,0,.2)}
        .chat-input{display:flex;gap:10px}
        .chat-input input{flex:1;padding:10px;background:rgba(0,0,0,.5);border:1px solid #ffd700;color:#e0e0e0;font-family:'Rajdhani',sans-serif;border-radius:5px}
        .chat-input button{padding:10px 20px;background:#ffd700;border:none;color:#050505;font-family:'Orbitron',monospace;font-weight:700;cursor:pointer;border-radius:5px;transition:all .3s}
        .chat-input button:hover{background:#ff6b35}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:linear-gradient(135deg,#1a1a2e 0%,#050505 100%);border:3px solid #ffd700;border-radius:20px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 0 50px rgba(255,215,0,.5);animation:modalSlideIn .5s}
        @keyframes modalSlideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ffd700}
        .modal-title{font-family:'Orbitron',monospace;font-size:1.8em;color:#ffd700}
        .close-btn{background:#ff6b35;border:none;color:#fff;font-size:1.5em;width:35px;height:35px;border-radius:50%;cursor:pointer;transition:all .3s}
        .close-btn:hover{transform:rotate(90deg);background:#ffd700;color:#050505}
        .info-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,215,0,.2)}
        .info-label{font-weight:700;color:#ff6b35}
        .badge{display:inline-block;padding:8px 15px;border-radius:20px;font-weight:700;font-size:.9em;margin:5px}
        .badge-green{background:linear-gradient(135deg,#0f0 0%,#0c0 100%);color:#050505;box-shadow:0 0 20px rgba(0,255,0,.5);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        .badge-yellow{background:linear-gradient(135deg,#ffd700 0%,#ff6b35 100%);color:#050505}
        .badge-red{background:linear-gradient(135deg,#ff6b35 0%,red 100%);color:#fff}
        .award-item{background:rgba(255,215,0,.1);padding:10px;margin:5px 0;border-left:3px solid #ffd700;border-radius:5px}
        .loading{text-align:center;padding:20px;color:#ffd700;font-size:1.2em}
        @media (max-width:1200px){.main-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FTC DECODE DASHBOARD</h1>
            <div class="subtitle">ARQUEOLOG√çA TECNOL√ìGICA ¬∑ TEMPORADA 2025-2026</div>
        </header>
        <div class="main-grid">
            <div class="data-section">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('events')">üìÖ EVENTOS</button>
                    <button class="tab-btn" onclick="switchTab('teams')">ü§ñ EQUIPOS</button>
                </div>
                <div id="events-tab" class="tab-content active">
                    <div class="loading" id="events-loading">Cargando eventos...</div>
                    <table id="events-table" style="display:none">
                        <thead><tr><th>Evento</th><th>Fecha</th><th>Ciudad</th><th>Venue</th></tr></thead>
                        <tbody id="events-tbody"></tbody>
                    </table>
                </div>
                <div id="teams-tab" class="tab-content">
                    <div class="loading" id="teams-loading">Cargando equipos...</div>
                    <table id="teams-table" style="display:none">
                        <thead><tr><th>#</th><th>Nombre</th><th>Ciudad</th><th>RP Total</th><th>Rookie</th></tr></thead>
                        <tbody id="teams-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div>
                <div class="game-panel">
                    <div class="game-title">‚ö†Ô∏è PROTOCOLO DE EXCAVACI√ìN ‚ö†Ô∏è</div>
                    <div class="game-stats">
                        <div class="stat-item"><div class="stat-label">Minas</div><div class="stat-value" id="mines-left">10</div></div>
                        <div class="stat-item"><div class="stat-label">Seguras</div><div class="stat-value" id="safe-cells">54</div></div>
                    </div>
                    <div class="game-grid" id="game-grid"></div>
                    <button class="game-btn" onclick="resetGame()">REINICIAR EXCAVACI√ìN</button>
                </div>
                <div class="chatbot-section">
                    <div class="chatbot-title">‚öñÔ∏è JUEZ NEUTRAL - REGLAMENTO</div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Pregunta sobre el reglamento...">
                        <button onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="team-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-team-name">Equipo</div>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            <div id="team-details"></div>
        </div>
    </div>
    <script>
        const GREEN_LIST=['28254','28255','11111'],RP_THRESHOLD=120,AWARD_BONUS={'inspire award':15,'winning alliance':10,'think award':10,'connect award':10,'innovate award':8,'design award':8,'control award':5,'motivate award':5};
        let eventsData=[],teamsData=[],gameBoard=[],revealedCells=0;
        const $=(id)=>document.getElementById(id),$$=(sel)=>document.querySelectorAll(sel);
        
        window.addEventListener('DOMContentLoaded',()=>{loadFTCData();initGame();addWelcomeMessage()});
        
        async function loadFTCData(){
            try{
                const r=await fetch('/api/ftc-mexico-data'),d=await r.json();
                eventsData=d.events;teamsData=d.teams;
                displayEvents();displayTeams();
            }catch(e){
                $('events-loading').textContent='Error al cargar datos';
                $('teams-loading').textContent='Error al cargar datos';
            }
        }
        
        function displayEvents(){
            const tbody=$('events-tbody'),loading=$('events-loading'),table=$('events-table');
            tbody.innerHTML='';
            eventsData.forEach(e=>{
                const row=tbody.insertRow();
                row.innerHTML=`<td>${e.event_name}</td><td>${e.start_date}</td><td>${e.city}</td><td>${e.venue}</td>`;
            });
            loading.style.display='none';table.style.display='table';
        }
        
        function displayTeams(){
            const tbody=$('teams-tbody'),loading=$('teams-loading'),table=$('teams-table');
            tbody.innerHTML='';
            teamsData.forEach(t=>{
                const row=tbody.insertRow();
                row.style.cursor='pointer';
                row.onclick=()=>showTeamDetail(t.team_key);
                row.innerHTML=`<td>${t.team_number}</td><td>${t.team_name_short}</td><td>${t.city}</td><td>${t.rp_total||0}</td><td>${t.rookie_year}</td>`;
            });
            loading.style.display='none';table.style.display='table';
        }
        
        async function showTeamDetail(key){
            try{
                const r=await fetch(`/api/team-detail/${key}`),d=await r.json(),t=teamsData.find(x=>x.team_key===key);
                const modal=$('team-modal'),isGreen=GREEN_LIST.includes(key);
                let rpTotal=d.rankings?.rp||t.rp_total||0,statusBadge='';
                
                if(isGreen){
                    statusBadge='<span class="badge badge-green">‚úÖ CLASIFICADO (RETROACTIVO)</span>';
                }else{
                    let bonus=0;
                    if(d.awards&&d.awards.length>0){
                        d.awards.forEach(a=>{
                            const name=a.award_name.toLowerCase();
                            for(const[k,v]of Object.entries(AWARD_BONUS)){
                                if(name.includes(k)){bonus+=v;break;}
                            }
                        });
                    }
                    rpTotal+=bonus;
                    statusBadge=rpTotal>=RP_THRESHOLD?'<span class="badge badge-yellow">üéØ EN ZONA DE PASE</span>':'<span class="badge badge-red">‚ö†Ô∏è A√öN NO CLASIFICA</span>';
                }
                
                let awards='<div class="awards-list"><strong>Premios Ganados:</strong>';
                if(d.awards&&d.awards.length>0){
                    d.awards.forEach(a=>awards+=`<div class="award-item">üèÜ ${a.award_name}</div>`);
                }else{
                    awards+='<div class="award-item">Sin premios registrados</div>';
                }
                awards+='</div>';
                
                $('modal-team-name').textContent=`#${t.team_number} - ${t.team_name_short}`;
                $('team-details').innerHTML=`
                    <div style="text-align:center;margin-bottom:20px">${statusBadge}</div>
                    <div class="info-row"><span class="info-label">N√∫mero de Equipo:</span><span>${t.team_number}</span></div>
                    <div class="info-row"><span class="info-label">Ciudad:</span><span>${t.city}</span></div>
                    <div class="info-row"><span class="info-label">A√±o Rookie:</span><span>${t.rookie_year}</span></div>
                    <div class="info-row"><span class="info-label">RP Totales:</span><span style="color:#ffd700;font-weight:700;font-size:1.2em">${rpTotal}</span></div>
                    <div class="info-row"><span class="info-label">Ranking Actual:</span><span>${d.rankings?.rank||'N/A'}</span></div>
                    ${awards}
                `;
                modal.classList.add('active');
            }catch(e){alert('Error al cargar los detalles del equipo');}
        }
        
        function closeModal(){$('team-modal').classList.remove('active')}
        
        function switchTab(tab){
            $$('.tab-btn').forEach(b=>b.classList.remove('active'));
            $$('.tab-content').forEach(c=>c.classList.remove('active'));
            event.target.classList.add('active');
            $(`${tab}-tab`).classList.add('active');
        }
        
        function initGame(){
            gameBoard=[];revealedCells=0;
            const grid=$('game-grid');
            grid.innerHTML='';
            for(let i=0;i<64;i++)gameBoard.push({mine:false,revealed:false,adjacent:0});
            let placed=0;
            while(placed<10){
                const p=Math.floor(Math.random()*64);
                if(!gameBoard[p].mine){gameBoard[p].mine=true;placed++;}
            }
            for(let i=0;i<64;i++)if(!gameBoard[i].mine)gameBoard[i].adjacent=countMines(i);
            for(let i=0;i<64;i++){
                const cell=document.createElement('div');
                cell.className='game-cell';
                cell.dataset.index=i;
                cell.onclick=()=>revealCell(i);
                grid.appendChild(cell);
            }
            updateStats();
        }
        
        function countMines(idx){
            const row=Math.floor(idx/8),col=idx%8;
            let c=0;
            for(let r=-1;r<=1;r++){
                for(let k=-1;k<=1;k++){
                    if(r===0&&k===0)continue;
                    const nr=row+r,nc=col+k;
                    if(nr>=0&&nr<8&&nc>=0&&nc<8&&gameBoard[nr*8+nc].mine)c++;
                }
            }
            return c;
        }
        
        function revealCell(idx){
            if(gameBoard[idx].revealed)return;
            const cell=document.querySelector(`[data-index="${idx}"]`);
            gameBoard[idx].revealed=true;
            cell.classList.add('revealed');
            revealedCells++;
            if(gameBoard[idx].mine){
                cell.classList.add('mine');
                cell.textContent='üí£';
                alert('¬°BOOM! Reiniciando protocolo...');
                resetGame();
            }else{
                const adj=gameBoard[idx].adjacent;
                if(adj>0){
                    cell.textContent=adj;
                    cell.style.color=['#0f0','#ffd700','#ff6b35','red'][Math.min(adj-1,3)];
                }else{
                    cell.textContent='‚úì';
                    cell.style.color='#0f0';
                }
                if(revealedCells===54)alert('¬°EXCAVACI√ìN COMPLETADA!');
            }
            updateStats();
        }
        
        function updateStats(){$('mines-left').textContent=10;$('safe-cells').textContent=54-revealedCells}
        function resetGame(){initGame()}
        
        function addWelcomeMessage(){
            $('chat-messages').innerHTML='<div class="chat-message bot-message">‚öñÔ∏è Hola, soy el Juez Neutral de FTC. Pregunta sobre: puntos, premios, clasificaci√≥n, robot, aut√≥nomo, teleop, endgame y faltas.</div>';
        }
        
        async function sendMessage(){
            const input=$('chat-input'),q=input.value.trim();
            if(!q)return;
            const msg=$('chat-messages');
            msg.innerHTML+=`<div class="chat-message user-message">${q}</div>`;
            input.value='';
            try{
                const r=await fetch('/api/nasa-rag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q})}),d=await r.json();
                msg.innerHTML+=`<div class="chat-message bot-message">${d.response}</div>`;
                msg.scrollTop=msg.scrollHeight;
            }catch(e){
                msg.innerHTML+='<div class="chat-message bot-message">Error al procesar la pregunta.</div>';
            }
        }
        
        $('chat-input').addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage()});
    </script>
</body>
</html>
