<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>AZTLAN COMMAND OS v6.0 (DIRECT LINK)</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">

<style>
/* =================== ESTILOS CORE =================== */
:root {
    --bg-deep: #020204;
    --neon-blue: #00f3ff;
    --neon-gold: #ffd700;
    --neon-red: #ff3333;
    --neon-green: #0aff0a;
    --panel-bg: rgba(8, 12, 20, 0.98);
    --font-title: 'Orbitron', sans-serif;
    --font-body: 'Rajdhani', sans-serif;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; background: var(--bg-deep); color: #e0e0e0; font-family: var(--font-body); overflow: hidden; height: 100vh; }

/* BOOT SCREEN */
#boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease-out; }
.aztec-loader { position: relative; width: 150px; height: 150px; display: flex; justify-content: center; align-items: center; }
.aztec-ring-outer { position: absolute; width: 100%; height: 100%; border: 2px dashed var(--neon-gold); border-radius: 50%; animation: spinReverse 10s linear infinite; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
.aztec-ring-mid { position: absolute; width: 70%; height: 70%; border: 4px solid transparent; border-top: 4px solid var(--neon-blue); border-bottom: 4px solid var(--neon-blue); border-radius: 50%; animation: spin 3s linear infinite; }
.aztec-core { width: 20px; height: 20px; background: var(--neon-gold); transform: rotate(45deg); box-shadow: 0 0 30px var(--neon-gold); animation: pulseCore 1s infinite alternate; }
.boot-text { margin-top: 40px; font-family: var(--font-title); color: var(--neon-blue); letter-spacing: 4px; font-size: 14px; text-align: center; animation: textFlicker 2s infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@keyframes spinReverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
@keyframes pulseCore { 0% { transform: rotate(45deg) scale(0.8); opacity: 0.5; } 100% { transform: rotate(45deg) scale(1.2); opacity: 1; } }
@keyframes textFlicker { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

#galaxy-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
.scanline { width: 100%; height: 100%; z-index: 90; position: fixed; pointer-events: none; opacity: 0.05; background: linear-gradient(to bottom, transparent 50%, rgba(0, 243, 255, 0.1) 51%); background-size: 100% 4px; }

header { position: absolute; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--neon-blue); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; backdrop-filter: blur(10px); }
.brand { font-family: var(--font-title); font-size: 18px; font-weight: 700; color: var(--neon-gold); letter-spacing: 2px; }
.level-badge { border: 1px solid var(--neon-blue); padding: 5px 10px; border-radius: 5px; font-size: 12px; color: var(--neon-blue); font-family: monospace; font-weight: bold; }

/* DOCK */
.dock { position: absolute; top: 60px; left: 0; bottom: 0; width: 70px; background: rgba(0,0,0,0.6); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px; z-index: 90; }
.dock-btn { width: 50px; height: 50px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); color: #888; display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer; transition: 0.3s; }
.dock-btn:hover { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); transform: scale(1.1); }
.tooltip { position: absolute; left: 60px; background: var(--neon-blue); color: #000; padding: 2px 6px; font-size: 10px; font-weight: bold; border-radius: 4px; display: none; white-space: nowrap; font-family: var(--font-title); }
.dock-btn:hover .tooltip { display: block; }

/* VENTANAS */
.window { position: absolute; background: var(--panel-bg); border: 1px solid var(--neon-blue); border-radius: 10px; box-shadow: 0 0 40px rgba(0,0,0,0.9); backdrop-filter: blur(15px); display: none; flex-direction: column; overflow: hidden; animation: openWin 0.3s ease-out; min-width: 300px; }
@keyframes openWin { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
.win-header { height: 40px; background: rgba(0, 243, 255, 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; cursor: grab; }
.win-title { font-family: var(--font-title); font-size: 12px; color: var(--neon-blue); letter-spacing: 1px; }
.win-close { background: none; border: none; color: #fff; cursor: pointer; font-size: 16px; }
.win-body { flex: 1; overflow-y: auto; padding: 20px; color: #ddd; font-size: 14px; line-height: 1.6; }

/* METEORITO */
#meteor-chat-btn { position: fixed; bottom: 30px; right: 30px; width: 70px; height: 70px; background: radial-gradient(circle at 30% 30%, #ffcc00, #ff4400); border-radius: 50%; border: 2px solid #ffaa00; cursor: pointer; z-index: 1000; box-shadow: 0 0 30px rgba(255, 68, 0, 0.6); animation: meteorFloat 3s infinite alternate; display: flex; justify-content: center; align-items: center; font-size: 30px; color: #fff; }
#meteor-chat-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 160%; height: 160%; background: radial-gradient(circle, rgba(255, 85, 0, 0.3) 0%, transparent 70%); transform: translate(-50%, -50%); z-index: -1; animation: firePulse 2s infinite; }
@keyframes meteorFloat { from { transform: translateY(0); } to { transform: translateY(-10px); } }
@keyframes firePulse { 0% { scale: 1; opacity: 0.5; } 50% { scale: 1.2; opacity: 0.8; } 100% { scale: 1; opacity: 0.5; } }

/* CHAT */
.msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; max-width: 85%; }
.msg.ai { background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: #fff; align-self: flex-start; }
.msg.user { background: rgba(255, 170, 0, 0.2); border: 1px solid var(--neon-gold); color: #fff; align-self: flex-end; text-align: right; }

/* VISUALIZADOR PLANETA */
#hologram-container { width: 100%; height: 150px; margin-bottom: 20px; background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0, 243, 255, 0.1) 100%); border: 1px dashed var(--neon-blue); border-radius: 10px; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
#planet-viz { width: 80px; height: 80px; border-radius: 50%; background: #444; box-shadow: inset -10px -10px 20px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,255,0.2); transition: all 0.5s ease; position: relative; }
#planet-name-label { position: absolute; bottom: 5px; width: 100%; text-align: center; color: var(--neon-gold); font-family: var(--font-title); font-size: 14px; text-shadow: 0 0 5px var(--neon-gold); }

/* UI ELEMENTS */
.input-label { display: block; color: var(--neon-gold); font-family: var(--font-title); font-size: 11px; margin-bottom: 5px; letter-spacing: 1px; text-transform: uppercase; text-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
.input-tech { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 14px; transition: 0.3s; }
.input-tech:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); outline: none; }

/* GAME CANVAS */
#game-canvas { background: #000; border: 1px solid #333; width: 100%; height: 350px; cursor: crosshair; display: block; border-radius: 5px; }
#game-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; }
.game-btn { padding: 10px 20px; background: var(--neon-red); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; font-family: var(--font-title); font-size: 16px; margin-top: 10px; }

/* DOCUMENTACI√ìN ESTILOS */
.doc-content h3 { color: var(--neon-blue); border-bottom: 1px solid rgba(0,243,255,0.2); padding-bottom: 5px; margin-top: 20px; }
.doc-content ul { padding-left: 20px; color: #ccc; }
.code-block { background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #333; color: var(--neon-green); font-family: monospace; margin: 10px 0; display: block; }

/* RESPONSIVE */
@media (max-width: 768px) {
    .dock { width: 100%; height: 60px; top: auto; bottom: 0; flex-direction: row; justify-content: center; border-right: none; border-top: 1px solid #333; }
    .window { width: 94% !important; height: 80% !important; top: 70px !important; left: 3% !important; }
    #meteor-chat-btn { bottom: 80px; right: 20px; width: 60px; height: 60px; font-size: 24px; }
}
</style>
</head>
<body>

<div id="boot-screen">
    <div class="aztec-loader"><div class="aztec-ring-outer"></div><div class="aztec-ring-mid"></div><div class="aztec-core"></div></div>
    <div class="boot-text" id="boot-text">SISTEMA INICIANDO...</div>
</div>

<canvas id="galaxy-canvas"></canvas>
<div class="scanline"></div>

<header>
    <div class="brand"><i class="fas fa-sun"></i> PROYECTO AZTL√ÅN</div>
    <div class="level-badge" id="user-rank">CAPIT√ÅN (NVL 1)</div>
</header>

<div class="dock">
    <div class="dock-btn" onclick="openWindow('win-nasa')"><i class="fas fa-eye"></i><div class="tooltip">NASA EYES</div></div>
    
    <div class="dock-btn" onclick="openWindow('win-analysis')"><i class="fas fa-atom"></i><div class="tooltip">AN√ÅLISIS</div></div>
    <div class="dock-btn" onclick="openWindow('win-game')"><i class="fas fa-gamepad"></i><div class="tooltip">DEFENSA</div></div>
    <div class="dock-btn" onclick="openWindow('win-docs')"><i class="fas fa-book"></i><div class="tooltip">DATOS</div></div>
    <div class="dock-btn" onclick="openWindow('win-gallery')"><i class="fas fa-satellite"></i><div class="tooltip">FOTOS</div></div>
</div>

<button id="meteor-chat-btn" onclick="toggleChat()"><i class="fas fa-comment"></i></button>

<div id="win-nasa" class="window" style="width: 900px; height: 600px; top: 80px; left: 120px;">
    <div class="win-header">
        <div class="win-title">/// VISOR_TELESCOPIO.EXE</div>
        <button class="win-close" onclick="closeWindow('win-nasa')">‚úï</button>
    </div>
    <div class="win-body" style="padding:0; overflow:hidden; background:#000;">
        <iframe src="https://eyes.nasa.gov/apps/exo/" style="width:100%; height:100%; border:none;"></iframe>
    </div>
</div>

<div id="win-analysis" class="window" style="display:flex; width: 750px; height: 680px; top: 100px; left: 150px;">
    <div class="win-header">
        <div class="win-title">/// CLASIFICADOR_RF.EXE</div>
        <button class="win-close" onclick="closeWindow('win-analysis')">‚úï</button>
    </div>
    <div class="win-body">
        
        <div id="hologram-container">
            <div id="planet-viz"></div>
            <div id="planet-name-label">SIN OBJETIVO</div>
        </div>

        <div style="margin-bottom: 20px;">
            <span class="input-label">NOMBRE DE MISI√ìN / PLANETA</span>
            <div style="display:flex; gap:10px;">
                <input type="text" class="input-tech" id="planet_name" placeholder="Ej: Nueva Tierra (O dejar vac√≠o)" oninput="updateHologram()">
                <button onclick="setRandomName()" style="background:#333; border:1px solid var(--neon-gold); color:#fff; cursor:pointer; border-radius:5px; padding:0 15px;" title="Generar nombre aleatorio">üé≤</button>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
            <div>
                <span class="input-label">RADIO DEL PLANETA (R‚äï)</span>
                <input type="number" id="koi_prad" class="input-tech" placeholder="Ej. 1.2" value="1.2" oninput="updateHologram()">
            </div>
            <div>
                <span class="input-label">RADIO DE LA ESTRELLA (R‚òâ)</span>
                <input type="number" id="koi_srad" class="input-tech" placeholder="Ej. 1.0" value="1.0">
            </div>
            <div>
                <span class="input-label">PERIODO ORBITAL (D√çAS)</span>
                <input type="number" id="koi_period" class="input-tech" placeholder="Ej. 365" value="365">
            </div>
            <div>
                <span class="input-label">TEMPERATURA (KELVIN)</span>
                <input type="number" id="koi_steff" class="input-tech" placeholder="Ej. 288" value="288" oninput="updateHologram()">
            </div>
        </div>
        
        <button onclick="runAnalysis()" style="width:100%; padding:15px; background:linear-gradient(90deg, var(--neon-blue), var(--neon-green)); border:none; font-weight:bold; cursor:pointer; border-radius:5px; color:#000; font-family:var(--font-title); letter-spacing:1px;">INICIAR AN√ÅLISIS</button>
        
        <div id="ml-result" style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.3); border-radius:5px; display:none;"></div>
        <div id="deep-report-container" style="margin-top:10px;"></div>
    </div>
</div>

<div id="win-game" class="window" style="width: 500px; height: 550px; top: 100px; left: 300px; border-color: var(--neon-red);">
    <div class="win-header" style="background: rgba(255,0,0,0.1);"><div class="win-title" style="color:var(--neon-red);">/// DEFENSA_ORBITAL</div><button class="win-close" onclick="closeWindow('win-game')">‚úï</button></div>
    <div class="win-body" style="position:relative; padding:0; overflow:hidden;">
        <div id="game-overlay">
            <h2 style="color:var(--neon-red);">ALERTA DE IMPACTO</h2>
            <p style="color:#ddd; font-size:14px; max-width:80%; line-height:1.6;">
                ¬°Capit√°n! Asteroides detectados.<br>
                Usa el mouse para controlar el l√°ser de defensa.
                <br><br>
                <strong>üéÆ CONTROLES:</strong><br>
                ‚Ä¢ Mueve el mouse para apuntar.<br>
                ‚Ä¢ Clic izquierdo para disparar.<br>
                ‚Ä¢ ¬°No dejes que toquen la base!
            </p>
            <button class="game-btn" onclick="startGame()">DESPLEGAR CAZAS</button>
        </div>
        <div style="position:absolute; top:10px; left:10px; font-family:monospace; color:var(--neon-gold); pointer-events:none;">
            SCORE: <span id="game-score">0</span>
        </div>
        <canvas id="game-canvas"></canvas>
    </div>
</div>

<div id="win-docs" class="window" style="width: 800px; height: 600px; top: 120px; left: 150px;">
    <div class="win-header"><div class="win-title">/// ARCHIVOS_SISTEMA.DAT</div><button class="win-close" onclick="closeWindow('win-docs')">‚úï</button></div>
    <div class="win-body doc-content">
        <h1 style="color:var(--neon-blue);">Proyecto Aztl√°n: Identificaci√≥n de Exoplanetas con Machine Learning</h1>
        <p><strong>Estado:</strong> Clasificado | <strong>Versi√≥n:</strong> 5.1 Final</p>

        <h3>1. Objetivo del Proyecto</h3>
        <p>Predecir si un objeto espacial detectado por misiones telesc√≥picas (Kepler, K2, TESS) es un exoplaneta confirmado, utilizando aprendizaje autom√°tico, datos reales y una interfaz interactiva que puede ser usada tanto de manera educativa como profesional.</p>

        <h3>2. Base de Datos y Caracter√≠sticas</h3>
        <p>Los datos provienen del <em>NASA Exoplanet Archive</em>, combinando tres misiones: Kepler, K2 y TESS.</p>
        <p>Cada registro contiene 148 caracter√≠sticas posibles. Para este modelo se seleccionaron 4 principales:</p>
        <ul>
            <li><strong style="color:var(--neon-gold)">koi_prad:</strong> Radio del planeta (radios terrestres).</li>
            <li><strong style="color:var(--neon-gold)">koi_srad:</strong> Radio de la estrella (radios solares).</li>
            <li><strong style="color:var(--neon-gold)">koi_period:</strong> Per√≠odo orbital del planeta (d√≠as).</li>
            <li><strong style="color:var(--neon-gold)">koi_steff:</strong> Temperatura efectiva de la estrella (Kelvin).</li>
        </ul>

        <h3>3. Preprocesamiento y Escalado</h3>
        <p>Se eliminan registros con datos faltantes. Las caracter√≠sticas se normalizan usando <code>StandardScaler</code> de Scikit-learn:</p>
        <div class="code-block">X_scaled = (X - Œº) / œÉ</div>
        <p>Esto evita que variables con rangos distintos dominen el entrenamiento. El scaler se guarda como <code>scaler.pkl</code>.</p>

        <h3>4. Entrenamiento del Modelo</h3>
        <p><strong>Algoritmo:</strong> Random Forest Classifier. Conjunto de √°rboles de decisi√≥n donde la clase final se obtiene por votaci√≥n mayoritaria.</p>
        <p><strong>Divisi√≥n:</strong> 80% entrenamiento, 20% prueba.</p>
        <p><strong>Probabilidad:</strong> <code>P(confirmado) = promedio de probabilidades de todos los √°rboles</code></p>
        <p>Modelo guardado como <code>model_rf.pkl</code>.</p>

        <h3>5. Arquitectura de la App</h3>
        <ul>
            <li><strong>Frontend:</strong> Interfaz interactiva Cyber-Azteca (HTML5/JS/Three.js).</li>
            <li><strong>Backend:</strong> Python + Llama 3 (Simulando el motor de inferencia de Scikit-learn).</li>
            <li><strong>Flujo:</strong> Usuario ingresa datos -> Escalado -> Predicci√≥n Random Forest -> Resultado Visual.</li>
        </ul>

        <h3>6. Fundamento T√©cnico</h3>
        <p>El modelo analiza patrones como el tama√±o del planeta vs. estrella y la estabilidad gravitacional del periodo orbital.</p>
        <ul style="list-style: none; padding: 0;">
            <li>‚úÖ <code>pred = 1</code> ‚Üí Exoplaneta Confirmado</li>
            <li>‚ùå <code>pred = 0</code> ‚Üí Falso Positivo</li>
        </ul>

        <h3>7. Expansi√≥n Futura</h3>
        <p>Incluir visualizaci√≥n de √≥rbitas (Implementado), diagramas H-R y modelos de Deep Learning.</p>
    </div>
</div>

<div id="win-gallery" class="window" style="width: 600px; height: 500px; top: 140px; left: 200px;">
    <div class="win-header"><div class="win-title">/// FEED_NASA</div><button class="win-close" onclick="closeWindow('win-gallery')">‚úï</button></div>
    <div class="win-body">
        <div style="display:flex; gap:10px; margin-bottom:15px;"><input id="nasa-q" placeholder="Buscar..." style="flex:1; background:#222; border:none; color:#fff; padding:8px;"><button onclick="loadNasa()" style="background:var(--neon-blue); border:none; padding:0 15px; font-weight:bold; cursor:pointer;">GO</button></div>
        <div id="nasa-grid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px;"></div>
    </div>
</div>

<div id="win-chat" class="window" style="width: 350px; height: 500px; bottom: 120px; right: 30px; top: auto; left: auto; border-color: var(--neon-gold);">
    <div class="win-header" style="background: rgba(255, 170, 0, 0.1);">
        <div class="win-title" style="color: var(--neon-gold);">OR√ÅCULO AZTL√ÅN</div>
        <button class="win-close" onclick="toggleChat()">‚úï</button>
    </div>
    <div class="win-body" style="display:flex; flex-direction:column;">
        <div id="chat-history" style="flex:1; overflow-y:auto; display:flex; flex-direction:column;">
            <div class="msg ai">A la orden, Capit√°n. ¬øQu√© sistema investigamos?</div>
        </div>
        <form onsubmit="event.preventDefault(); sendChat();" style="display:flex; margin-top:10px; border-top:1px solid #333; padding-top:10px;">
            <input id="chat-input" placeholder="Pregunta..." style="flex:1; background:transparent; border:none; color:#fff; outline:none;">
            <button type="submit" style="background:none; border:none; color:var(--neon-gold); cursor:pointer;">‚û§</button>
        </form>
    </div>
</div>

<script>
// --- GLOBAL STATE ---
let userLevel = 1; let userXP = 0;

// --- BOOT ---
window.onload = () => {
    if(localStorage.getItem('aztlan_lvl')) { userLevel=parseInt(localStorage.getItem('aztlan_lvl')); userXP=parseInt(localStorage.getItem('aztlan_xp')); updateBadge(); }
    const texts = ["INICIANDO...", "HOLA CAPIT√ÅN...", "SISTEMA ONLINE"]; let i = 0;
    const interval = setInterval(() => { document.getElementById('boot-text').innerText = texts[i]; i++; if (i >= texts.length) { clearInterval(interval); setTimeout(() => { document.getElementById('boot-screen').style.opacity = '0'; setTimeout(() => document.getElementById('boot-screen').style.display = 'none', 1000); }, 800); } }, 800);
    init3D(); updateHologram();
};

function updateBadge() {
    let rank = "CADETE";
    if(userLevel > 5) rank = "OFICIAL"; if(userLevel > 10) rank = "COMANDANTE";
    document.getElementById('user-rank').innerText = `${rank} (NVL ${userLevel})`;
}
function addXP(amount) {
    userXP += amount; if(userXP > userLevel * 100) { userLevel++; userXP = 0; alert(`¬°ASCENSO! NIVEL ${userLevel}`); }
    localStorage.setItem('aztlan_lvl', userLevel); localStorage.setItem('aztlan_xp', userXP); updateBadge();
}

// --- NAME GENERATOR ---
function setRandomName() {
    const p = ["Kepler", "Gliese", "Aztlan", "Proxima", "Zorgon", "K2", "Trappist", "Centauri", "Nova", "Helios"];
    const s = ["Prime", "Beta", "X", "Omicron", "b", "c", "d", "Major", "Minor", "Z-9"];
    const n = Math.floor(Math.random() * 999);
    const name = `${p[Math.floor(Math.random()*p.length)]}-${n} ${s[Math.floor(Math.random()*s.length)]}`;
    document.getElementById('planet_name').value = name;
    updateHologram();
    return name;
}

// --- VISUALIZADOR ---
function updateHologram() {
    let name = document.getElementById('planet_name').value;
    if(!name) name = "SIN OBJETIVO";
    document.getElementById('planet-name-label').innerText = name.toUpperCase();
    
    const planet = document.getElementById('planet-viz');
    const radInput = parseFloat(document.getElementById('koi_prad').value) || 1;
    const tempInput = parseFloat(document.getElementById('koi_steff').value) || 288;
    
    let scale = 1 + (radInput / 10); if (scale > 2) scale = 2;
    planet.style.transform = `scale(${scale})`;

    let color = "#444"; 
    if (tempInput < 200) color = "#aaddff"; 
    else if (tempInput >= 200 && tempInput < 350) color = "#00ff88"; 
    else if (tempInput >= 350 && tempInput < 1000) color = "#ddaa00"; 
    else if (tempInput >= 1000) color = "#ff3300"; 

    planet.style.background = `radial-gradient(circle at 30% 30%, ${color}, #000)`;
    planet.style.boxShadow = `0 0 ${tempInput/50}px ${color}`;
}

// --- ANALYSIS ---
async function runAnalysis() {
    const resBox = document.getElementById('ml-result');
    const deepBox = document.getElementById('deep-report-container');
    deepBox.innerHTML = ''; deepBox.style.display = 'none';
    
    let pName = document.getElementById('planet_name').value.trim();
    if (!pName) { pName = setRandomName(); }

    const payload = { 
        planet_name: pName,
        koi_prad: document.getElementById('koi_prad').value, 
        koi_srad: document.getElementById('koi_srad').value, 
        koi_period: document.getElementById('koi_period').value, 
        koi_steff: document.getElementById('koi_steff').value 
    };
    resBox.style.display = 'block'; resBox.innerHTML = 'Calculando...';
    
    try {
        const response = await fetch('/api/aztlan-predict', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        const data = await response.json();
        const isConf = data.prediccion.toUpperCase().includes("CONFIRMADO");
        const color = isConf ? "var(--neon-green)" : "var(--neon-red)";
        if(isConf) addXP(50); else addXP(10); 

        resBox.innerHTML = `
            <div style="font-size:20px; font-weight:bold; color:${color}; font-family:var(--font-title);">${data.prediccion}</div>
            <div style="font-family:monospace; color:var(--neon-blue);">Probabilidad: ${data.probabilidad}</div>
            <div style="font-size:13px; color:#ddd; margin-top:10px;">${data.analisis_tecnico}</div>
            <button onclick='runDeepScan(${JSON.stringify(payload)})' style="margin-top:10px; width:100%; padding:10px; background:var(--neon-gold); border:none; color:#000; font-weight:bold; cursor:pointer; border-radius:5px;">üî¨ INFORME CIENT√çFICO</button>
        `;
    } catch (e) { resBox.innerHTML = 'Error IA.'; }
}

async function runDeepScan(payload) {
    const box = document.getElementById('deep-report-container');
    box.style.display = 'block'; box.innerHTML = '<div style="color:var(--neon-blue); text-align:center;">Generando reporte...</div>';
    try {
        const res = await fetch('/api/aztlan-deep', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        box.innerHTML = marked.parse(data.report);
        addXP(100);
    } catch(e) { box.innerHTML = 'Error.'; }
}

// --- MINIJUEGO: SPACE DEFENDER ---
let gameInterval; const canvas = document.getElementById('game-canvas'); const ctx = canvas.getContext('2d');
let ship = { x: 0, width: 30, height: 30 };
let bullets = []; let enemies = []; let score = 0; let gameActive = false;

function startGame() {
    document.getElementById('game-overlay').style.display = 'none';
    gameActive = true; score = 0; bullets = []; enemies = [];
    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
    ship.x = canvas.width / 2;
    
    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        ship.x = e.clientX - rect.left;
    });
    canvas.addEventListener('mousedown', () => {
        if(gameActive) bullets.push({ x: ship.x, y: canvas.height - 40 });
    });

    if(gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(updateGame, 20);
}

function updateGame() {
    if(!gameActive) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#00f3ff';
    ctx.beginPath(); ctx.moveTo(ship.x, canvas.height-40); ctx.lineTo(ship.x-15, canvas.height-10); ctx.lineTo(ship.x+15, canvas.height-10); ctx.fill();

    ctx.fillStyle = '#ffff00';
    bullets.forEach((b, i) => {
        b.y -= 10; ctx.fillRect(b.x-2, b.y, 4, 10);
        if(b.y < 0) bullets.splice(i, 1);
    });

    if(Math.random() < 0.05) enemies.push({ x: Math.random()*canvas.width, y: -20, r: 15 });
    
    enemies.forEach((e, i) => {
        e.y += 2; 
        ctx.fillStyle = '#ff3333'; ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
        
        bullets.forEach((b, j) => {
            if(Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2) < e.r) {
                enemies.splice(i, 1); bullets.splice(j, 1); score += 10;
                document.getElementById('game-score').innerText = score;
            }
        });

        if(e.y > canvas.height) {
            gameActive = false;
            document.getElementById('game-overlay').style.display = 'flex';
            document.getElementById('game-overlay').innerHTML = `<h2 style="color:red">¬°MISI√ìN FALLIDA!</h2><p>Puntaje: ${score}</p><button class="game-btn" onclick="startGame()">REINTENTAR</button>`;
        }
    });
}

// --- UTILS ---
function toggleChat() { const w = document.getElementById('win-chat'); w.style.display = w.style.display==='flex'?'none':'flex'; if(w.style.display==='flex') document.getElementById('chat-input').focus(); }
function openWindow(id) { document.querySelectorAll('.window').forEach(w => w.style.zIndex = 10); const w = document.getElementById(id); w.style.display = 'flex'; w.style.zIndex = 20; }
function closeWindow(id) { document.getElementById(id).style.display = 'none'; }
async function sendChat() { const inp = document.getElementById('chat-input'); const txt = inp.value.trim(); if(!txt)return; const h = document.getElementById('chat-history'); h.innerHTML += `<div class="msg user">${txt}</div>`; inp.value=''; const res = await fetch('/api/nasa-rag', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_query:txt})}); const d = await res.json(); h.innerHTML += `<div class="msg ai">${marked.parse(d.answer)}</div>`; h.scrollTop=h.scrollHeight; }
async function loadNasa() { const q = document.getElementById('nasa-q').value || 'nebula'; const g = document.getElementById('nasa-grid'); g.innerHTML='Cargando...'; const r = await fetch(`/api/nasa-feed?q=${q}`); const d = await r.json(); g.innerHTML=''; d.forEach(i => { const el=document.createElement('div'); el.style.cssText=`height:100px;background:url(${i.url}) center/cover;border-radius:5px;cursor:pointer;`; el.onclick=()=>window.open(i.url); g.appendChild(el); }); }
function init3D() { const s = new THREE.Scene(); const c = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000); const r = new THREE.WebGLRenderer({canvas: document.getElementById('galaxy-canvas'), alpha: true}); r.setSize(window.innerWidth, window.innerHeight); const g = new THREE.BufferGeometry(); const p = []; for(let i=0; i<3000; i++) p.push((Math.random()-0.5)*2000, (Math.random()-0.5)*2000, (Math.random()-0.5)*2000); g.setAttribute('position', new THREE.Float32BufferAttribute(p, 3)); const m = new THREE.PointsMaterial({color:0x00f3ff, size:1.5}); s.add(new THREE.Points(g, m)); c.position.z = 1; const a = () => { requestAnimationFrame(a); s.children[0].rotation.y += 0.0005; s.children[0].position.z += 0.5; if(s.children[0].position.z>500) s.children[0].position.z=-500; r.render(s, c); }; a(); window.addEventListener('resize', ()=>{r.setSize(window.innerWidth, window.innerHeight); c.aspect=window.innerWidth/window.innerHeight; c.updateProjectionMatrix();}); }
// Drag
document.querySelectorAll('.win-header').forEach(h => { h.addEventListener('mousedown', e => { if(window.innerWidth<768)return; const w=h.parentElement; let offX=e.clientX-w.offsetLeft, offY=e.clientY-w.offsetTop; const move=e=>{w.style.left=(e.clientX-offX)+'px'; w.style.top=(e.clientY-offY)+'px';}; document.addEventListener('mousemove',move); document.onmouseup=()=>{document.removeEventListener('mousemove',move);}; }); });
</script>
</body>
</html>