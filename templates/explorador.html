<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>FTC UPLINK: DECODE</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--gold:#ffd700;--org:#ff6b35;--bg:#050505;--pnl:rgba(20,20,30,0.95);--grn:#00ff00;--font-h:'Orbitron';--font-b:'Rajdhani'}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:#e0e0e0;font-family:var(--font-b);height:100vh;display:flex;flex-direction:column;overflow:hidden}
.bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;background:radial-gradient(circle at center,#1a1a1a 0,#000 100%);opacity:.8}
header{background:#000;border-bottom:2px solid var(--gold);padding:10px 20px;display:flex;justify-content:space-between;align-items:center}
.logo{font-family:var(--font-h);font-size:1.5em;color:var(--gold);letter-spacing:2px}.logo span{color:var(--org);font-size:.6em}
.main{flex:1;display:grid;grid-template-columns:3fr 1fr;gap:15px;padding:15px;overflow:hidden}
.panel{background:var(--pnl);border:1px solid #333;border-radius:5px;display:flex;flex-direction:column;overflow:hidden;position:relative}
.tabs{display:flex;background:#111;border-bottom:1px solid #333}.tab{padding:12px 20px;cursor:pointer;font-weight:700;color:#666;border-right:1px solid #222;font-family:var(--font-h);transition:.3s}
.tab:hover{color:#fff;background:#222}.tab.active{color:var(--gold);background:var(--pnl);border-top:3px solid var(--gold)}
.search-bar{padding:10px;background:#1a1a1a;border-bottom:1px solid #333;display:none}.search-bar input{width:100%;padding:8px;background:#000;border:1px solid var(--org);color:#fff;font-family:var(--font-h)}
.content{flex:1;overflow-y:auto}table{width:100%;border-collapse:collapse}th{text-align:left;padding:12px;background:#151515;color:var(--org);position:sticky;top:0;border-bottom:2px solid #333;font-family:var(--font-h);font-size:.9em}
td{padding:10px 12px;border-bottom:1px solid #222}tr:hover{background:rgba(255,215,0,.1);cursor:pointer}
.badge{padding:4px 8px;border-radius:4px;font-size:.8em;font-weight:700;font-family:var(--font-h)}.qt{background:#222;color:#fff;border:1px solid #444}.cmp{background:var(--gold);color:#000}
.chat-box{flex:1;overflow-y:auto;padding:10px;background:rgba(0,0,0,.3);font-size:.9em}.chat-in{background:#000;border:none;border-top:1px solid var(--gold);padding:10px;color:#fff;width:100%}
.msg{margin-bottom:8px;padding:5px 10px;border-radius:4px}.ai{color:var(--gold);border-left:2px solid var(--gold)}.us{text-align:right;color:#aaa}
.grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;width:fit-content;margin:10px auto}.cell{width:25px;height:25px;background:#333;border:1px solid #444;cursor:pointer;display:flex;justify-content:center;align-items:center}
.cell.safe{background:#003974;color:#fff}.cell.trap{background:#d32f2f}.cell.flag{color:var(--gold)}
#modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:99;justify-content:center;align-items:center}
.card{background:var(--pnl);border:2px solid var(--gold);width:500px;padding:25px;border-radius:10px;position:relative;box-shadow:0 0 40px rgba(255,215,0,.15)}
.close{position:absolute;top:10px;right:15px;color:#fff;font-size:1.5em;cursor:pointer;background:none;border:none}
.stat{display:flex;justify-content:space-between;margin:8px 0;font-size:1.1em}.val{font-weight:700;color:#fff}
.pass{background:rgba(0,255,0,.1);border:1px solid var(--grn);color:var(--grn);text-align:center;padding:10px;margin-top:15px}
.warn{background:rgba(255,215,0,.1);border:1px solid var(--gold);color:var(--gold);text-align:center;padding:10px;margin-top:15px}
.fail{background:rgba(255,0,0,.1);border:1px solid red;color:red;text-align:center;padding:10px;margin-top:15px}
@media(max-width:900px){.main{grid-template-columns:1fr}.side{display:none}}
</style>
</head>
<body>
<div class="bg"></div>
<header><div class="logo">FTC <span>DECODE</span></div><div style="font-size:.8em;color:#666">API: FIRST OFICIAL</div></header>
<div class="main">
    <div class="panel">
        <div class="tabs">
            <div class="tab active" onclick="tab('ev')" id="t-ev">EVENTOS</div>
            <div class="tab" onclick="tab('tm')" id="t-tm">EQUIPOS</div>
        </div>
        <div id="search-container" class="search-bar">
            <input type="text" id="team-search" placeholder="üîç Buscar equipo por nombre o n√∫mero..." onkeyup="filterTeams()">
        </div>
        
        <div id="v-ev" class="content">
            <table><thead><tr><th>TIPO</th><th>NOMBRE</th><th>FECHA</th><th>CIUDAD</th></tr></thead><tbody id="b-ev"></tbody></table>
        </div>
        <div id="v-tm" class="content" style="display:none">
            <table><thead><tr><th># NUM</th><th>NOMBRE EQUIPO</th><th>CIUDAD / ESTADO</th><th>ROOKIE</th></tr></thead><tbody id="b-tm"></tbody></table>
            <div id="loading-teams" style="text-align:center;padding:20px;color:var(--org)">Conectando con ftc-events.firstinspires.org...</div>
        </div>
    </div>
    
    <div class="panel side" style="gap:10px">
        <div class="panel" style="height:50%"><div style="padding:8px;color:var(--gold);border-bottom:1px solid #333;text-align:center;font-family:var(--font-h)">JUEZ VIRTUAL</div><div id="chat" class="chat-box"></div><input id="in" class="chat-in" placeholder="Consultar reglamento..." onkeypress="if(event.key==='Enter')send()"></div>
        <div class="panel" style="flex:1;border-color:var(--org)"><div style="padding:8px;color:var(--org);text-align:center;font-family:var(--font-h)">PROTOCOLO EXCAVACI√ìN</div><div id="game" class="grid"></div><div style="text-align:center;padding:5px"><button onclick="init()" style="background:#333;color:var(--org);border:1px solid var(--org);padding:2px 10px;cursor:pointer">RESET</button></div></div>
    </div>
</div>

<div id="modal">
    <div class="card">
        <button class="close" onclick="$('modal').style.display='none'">&times;</button>
        <h2 id="m-name" style="color:var(--gold);font-family:var(--font-h);border-bottom:1px solid #444;padding-bottom:10px;margin-top:0"></h2>
        <div id="m-data"></div>
    </div>
</div>

<script>
const $=id=>document.getElementById(id);
const GREEN_LIST=['17625','16818','6584','21735','21546','28254','15912','26961','22571','17627','17626','21764','24946','24976','28255','26333','30311','16655','16568','17755','12887','13531','25951','23619'];
const RP_THRESHOLD=120;
const BONUS={'inspire':15,'winning':10,'think':10,'connect':10,'innovate':8,'design':8,'control':5,'motivate':5};
let allTeams=[]; // Almacena todos los equipos para filtrar localmente

window.onload=async()=>{
    init();
    try {
        const r=await fetch('/api/ftc-mexico-data'); 
        const d=await r.json(); 
        
        // Render Eventos
        d.events.forEach(e=>$('b-ev').innerHTML+=`<tr><td><span class="badge ${e.type==='CMP'?'cmp':'qt'}">${e.type}</span></td><td>${e.n}</td><td>${e.d}</td><td>${e.c}</td></tr>`);
        
        // Guardar y Renderizar Equipos
        allTeams = d.teams;
        $('loading-teams').style.display='none';
        renderTeams(allTeams);

    } catch(e) {
        $('loading-teams').innerText = "Error de conexi√≥n con la API Oficial.";
    }
};

function renderTeams(list){
    const tbody = $('b-tm');
    tbody.innerHTML = '';
    list.forEach(t => {
        tbody.innerHTML += `<tr onclick="openTm('${t.id}')">
            <td style="color:var(--gold);font-weight:700;font-family:var(--font-h)">${t.id}</td>
            <td style="font-weight:bold">${t.n}</td>
            <td>${t.l}</td>
            <td>${t.r}</td>
        </tr>`;
    });
}

function filterTeams(){
    const term = $('team-search').value.toLowerCase();
    const filtered = allTeams.filter(t => t.n.toLowerCase().includes(term) || t.id.toString().includes(term));
    renderTeams(filtered);
}

async function openTm(id){
    $('modal').style.display='flex'; 
    $('m-name').innerText=`#${id} ESCANEANDO...`;
    $('m-data').innerHTML='<div style="text-align:center;color:#666">Conectando a base de datos...</div>';
    
    // Buscar info b√°sica
    const t = allTeams.find(x => x.id == id) || {n:'Desconocido', l:'MX'};
    
    // Pedir detalle a la API (Rankings y Premios)
    const r = await fetch(`/api/team-detail/${id}`); 
    const d = await r.json();
    
    let bonus=0, awList='';
    if(d.awards){
        d.awards.forEach(a=>{
            awList+=`<div style="font-size:0.8em;color:#aaa">üèÜ ${a.award_name}</div>`;
            for(let k in BONUS) if(a.award_name.toLowerCase().includes(k)) bonus+=BONUS[k];
        });
    }
    const totalRP = d.rankings.rp + bonus; // RP del juego + Bonus de premios
    const isGreen = GREEN_LIST.includes(id.toString());
    
    let badge=`<div class="fail">‚ö†Ô∏è A√öN NO CLASIFICA</div>`;
    if(isGreen) badge=`<div class="pass">‚úÖ CLASIFICADO (RETROACTIVO)</div>`;
    else if(totalRP > RP_THRESHOLD) badge=`<div class="warn">üéØ EN ZONA DE PASE (ACTUAL)</div>`;

    $('m-name').innerText=`#${t.id} ${t.n}`;
    $('m-data').innerHTML=`
        <div class="stat"><div>Ubicaci√≥n:</div><div class="val">${t.l}</div></div>
        <div class="stat"><div>RP Juego:</div><div class="val">${d.rankings.rp}</div></div>
        <div class="stat"><div>Bonus Premios:</div><div class="val" style="color:var(--gold)">+${bonus}</div></div>
        <div style="border-top:1px dashed #444;margin:10px 0"></div>
        <div class="stat"><div>TOTAL RP:</div><div class="val" style="font-size:1.4em">${totalRP}</div></div>
        ${badge}
        <div style="margin-top:15px;border-top:1px solid #333;padding-top:10px"><strong>Historial Premios:</strong>${awList||'<br>Sin premios registrados'}</div>
    `;
}

function tab(m){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); $(`t-${m}`).classList.add('active');
    $('v-ev').style.display=m==='ev'?'block':'none'; 
    $('v-tm').style.display=m==='tm'?'block':'none';
    $('search-container').style.display=m==='tm'?'block':'none'; // Mostrar buscador solo en equipos
}

async function send(){
    const i=$('in'),v=i.value; if(!v)return; 
    $('chat').innerHTML+=`<div class="msg us">${v}</div>`; i.value='';
    try{
        const r=await fetch('/api/nasa-rag',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_query:v, mode:'ftc'})});
        const d=await r.json(); $('chat').innerHTML+=`<div class="msg ai">${d.answer}</div>`;
    }catch{ $('chat').innerHTML+=`<div class="msg ai" style="color:red">Error.</div>`; }
    $('chat').scrollTop=$('chat').scrollHeight;
}

function init(){
    const g=$('game'); g.innerHTML='';
    for(let i=0;i<32;i++){
        let d=document.createElement('div'),m=Math.random()<.15;
        d.className='cell';
        d.onclick=()=>{d.className=m?'cell trap':'cell safe';if(!m)d.innerText='‚Ä¢';};
        d.oncontextmenu=(e)=>{e.preventDefault();d.className='cell flag';d.innerText='‚öë'};
        g.appendChild(d);
    }
}
</script>
</body>
</html>
