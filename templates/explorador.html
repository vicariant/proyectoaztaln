<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTC UPLINK: DECODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === ESTILO DECODE === */
        :root { --gold: #ffd700; --dark: #050505; --panel: rgba(20, 20, 30, 0.95); --accent: #ff6b35; --green-pass: #00ff00; }
        body { margin: 0; background: var(--dark); color: #e0e0e0; font-family: 'Rajdhani', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        
        /* NAV */
        nav { background: #000; border-bottom: 2px solid var(--gold); padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Orbitron'; font-size: 1.5em; color: var(--gold); }
        .btn { border: 1px solid var(--gold); color: var(--gold); background: transparent; padding: 5px 15px; cursor: pointer; font-family: 'Orbitron'; transition: 0.3s; }
        .btn:hover { background: var(--gold); color: #000; }

        /* GRID */
        .main { flex: 1; display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; padding: 20px; }
        .panel { background: var(--panel); border: 1px solid #333; border-radius: 5px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* TABS */
        .tabs { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab { padding: 15px 30px; cursor: pointer; font-weight: bold; color: #666; border-right: 1px solid #222; font-family: 'Orbitron'; }
        .tab.active { color: var(--gold); background: var(--panel); border-top: 3px solid var(--gold); }

        /* TABLAS */
        .content { flex: 1; overflow-y: auto; padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #151515; color: var(--accent); position: sticky; top: 0; border-bottom: 2px solid #333; font-family: 'Orbitron'; }
        td { padding: 12px 15px; border-bottom: 1px solid #222; }
        tr:hover { background: rgba(255, 215, 0, 0.1); cursor: pointer; }
        
        /* MODAL SCOUTING */
        #scout-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; justify-content:center; align-items:center; }
        .scout-card { background: var(--panel); border: 2px solid var(--gold); width: 500px; padding: 20px; border-radius: 10px; position: relative; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); }
        .scout-title { font-family: 'Orbitron'; font-size: 1.5em; color: var(--gold); border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 1.1em; }
        .stat-val { font-weight: bold; color: #fff; }
        .status-badge { text-align: center; padding: 10px; margin-top: 20px; font-weight: bold; border-radius: 5px; font-family: 'Orbitron'; }
        .status-pass { background: rgba(0, 255, 0, 0.1); border: 1px solid var(--green-pass); color: var(--green-pass); }
        .status-fail { background: rgba(255, 0, 0, 0.1); border: 1px solid red; color: red; }

        /* CHAT */
        .chat-zone { flex: 1; display: flex; flex-direction: column; padding: 15px; }
        .chat-msgs { flex: 1; overflow-y: auto; border: 1px solid #333; padding: 10px; margin-bottom: 10px; background: rgba(0,0,0,0.3); }
        .chat-in { background: #000; border: 1px solid var(--gold); color: #fff; padding: 10px; width: 100%; box-sizing: border-box; }
        .ai { color: var(--gold); margin-bottom: 8px; border-left: 2px solid var(--gold); padding-left: 8px; }
        .user { text-align: right; color: #aaa; margin-bottom: 8px; }

        /* MINESWEEPER */
        .mines-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 2px; width: fit-content; margin: 10px auto; }
        .cell { width: 25px; height: 25px; background: #333; border: 1px solid #444; cursor: pointer; display:flex; justify-content:center; align-items:center; }
        .cell:hover { background: #555; }
        .cell.safe { background: #003974; color:#fff; }
        .cell.trap { background: #d32f2f; }
        .cell.flag { color: var(--gold); }
    </style>
</head>
<body>
    <div class="bg"></div>
    <nav>
        <div class="logo">TOA <span>// DECODE</span></div>
        <button class="btn" onclick="window.location.href='/'">EXIT</button>
    </nav>

    <div class="main">
        <div class="panel">
            <div class="tabs">
                <div class="tab active" onclick="setTab('ev')" id="t-ev">EVENTOS (MX)</div>
                <div class="tab" onclick="setTab('tm')" id="t-tm">EQUIPOS</div>
            </div>
            
            <div id="view-ev" class="content">
                <table id="tbl-ev"><thead><tr><th>ESTADO</th><th>NOMBRE</th><th>CIUDAD</th><th>FECHA</th></tr></thead><tbody id="body-ev"></tbody></table>
            </div>
            <div id="view-tm" class="content" style="display:none;">
                <table id="tbl-tm"><thead><tr><th># TEAM</th><th>NOMBRE</th><th>UBICACIÓN</th><th>ACCIÓN</th></tr></thead><tbody id="body-tm"></tbody></table>
            </div>
            <div style="position:absolute; bottom:5px; right:10px; font-size:0.7em; color:#444;" id="data-source">CARGANDO...</div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            <div class="panel" style="height:50%;">
                <div style="padding:10px; border-bottom:1px solid #333; color:var(--gold); font-family:'Orbitron'">JUEZ VIRTUAL</div>
                <div class="chat-zone">
                    <div class="chat-msgs" id="chat-msgs"><div class="ai">Juez Neutral Online. ¿Dudas del reglamento?</div></div>
                    <input class="chat-in" id="chat-in" placeholder="Escribe..." onkeypress="if(event.key==='Enter') send()">
                </div>
            </div>
            <div class="panel" style="flex:1; border-color:var(--accent);">
                <div style="padding:10px; color:var(--accent); font-family:'Orbitron'; text-align:center;">EXCAVACIÓN</div>
                <div id="mines" class="mines-grid"></div>
                <div style="text-align:center;"><button onclick="initGame()" class="btn" style="border-color:var(--accent); color:var(--accent); font-size:0.7em;">REINICIAR</button></div>
            </div>
        </div>
    </div>

    <div id="scout-modal" onclick="closeModal(event)">
        <div class="scout-card">
            <button onclick="document.getElementById('scout-modal').style.display='none'" style="float:right; background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
            <div class="scout-title">ANÁLISIS DE EQUIPO #<span id="s-num"></span></div>
            <div style="color:#aaa; margin-bottom:20px;" id="s-name"></div>
            
            <div class="stat-row"><div>Ranking Points (Juego):</div> <div class="stat-val" id="s-rp-game">0</div></div>
            <div class="stat-row"><div>RP por Bonificación (Premios):</div> <div class="stat-val" style="color:var(--gold);" id="s-rp-bonus">0</div></div>
            <div style="border-top:1px dashed #555; margin:10px 0;"></div>
            <div class="stat-row"><div>TOTAL RP ESTIMADO:</div> <div class="stat-val" style="font-size:1.3em;" id="s-total">0</div></div>

            <div id="s-badge" class="status-badge status-fail">NO CLASIFICADO</div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE SCOUTING ---
        const CLAVES_CLASIFICADOS_VERDES = ["28254", "28255", "11111", "16380", "12345", "17755", "12887"]; // Tu lista de 29 equipos
        const UMBRAL_RP = 300; // Ajusta según tu criterio de pase

        window.onload = async () => {
            initGame();
            const res = await fetch('/api/ftc-mexico-data');
            const data = await res.json();
            document.getElementById('data-source').innerText = "FUENTE: " + data.source;

            // Llenar Eventos
            const bev = document.getElementById('body-ev');
            data.events.forEach(e => {
                bev.innerHTML += `<tr><td style="color:${e.status.includes('EN')?'#0f0':'#888'}">${e.status}</td><td style="font-weight:bold">${e.name}</td><td>${e.city}</td><td>${e.date.split('T')[0]}</td></tr>`;
            });

            // Llenar Equipos
            const btm = document.getElementById('body-tm');
            data.teams.forEach(t => {
                btm.innerHTML += `<tr onclick="abrirScout('${t.id}', '${t.name}')">
                    <td style="color:var(--gold); font-family:'Orbitron'">${t.id}</td>
                    <td>${t.name}</td>
                    <td>${t.loc}</td>
                    <td><button class="btn" style="padding:2px 8px; font-size:0.7em;">SCOUT</button></td>
                </tr>`;
            });
        };

        // --- LÓGICA DE SCOUTING AVANZADA ---
        async function abrirScout(id, name) {
            document.getElementById('s-num').innerText = id;
            document.getElementById('s-name').innerText = name;
            document.getElementById('s-rp-game').innerText = "...";
            document.getElementById('s-rp-bonus').innerText = "...";
            document.getElementById('s-total').innerText = "...";
            document.getElementById('s-badge').innerHTML = "CALCULANDO...";
            document.getElementById('scout-modal').style.display = 'flex';

            // 1. Obtener Datos Reales
            const res = await fetch(`/api/team-detail/${id}`);
            const data = await res.json();
            
            // 2. Calcular Bonificación Exacta
            const rpBonus = calcularRPBonificacion(data.awards, id);
            const rpJuego = data.rp;
            const total = rpJuego + rpBonus;

            // 3. Verificar Retroactivo
            const esVerde = CLAVES_CLASIFICADOS_VERDES.includes(id.toString());

            // 4. Renderizar
            document.getElementById('s-rp-game').innerText = rpJuego;
            document.getElementById('s-rp-bonus').innerText = rpBonus;
            document.getElementById('s-total').innerText = total;

            const badge = document.getElementById('s-badge');
            if (esVerde) {
                badge.className = 'status-badge status-pass';
                badge.innerHTML = '<i class="fas fa-check-circle"></i> CLASIFICADO (RETROACTIVO)';
            } else if (total >= UMBRAL_RP) {
                badge.className = 'status-badge status-pass';
                badge.style.borderColor = 'var(--gold)';
                badge.style.color = 'var(--gold)';
                badge.innerHTML = '<i class="fas fa-trophy"></i> ZONA DE PASE (ACTUAL)';
            } else {
                badge.className = 'status-badge status-fail';
                badge.innerHTML = 'AÚN NO CLASIFICA';
            }
        }

        function calcularRPBonificacion(awards, teamId) {
            let bonus = 0;
            if(!awards) return 0;
            awards.forEach(aw => {
                const name = aw.award_name.toLowerCase();
                // Reglas DECODE
                if (name.includes("inspire")) bonus += 15;
                else if (name.includes("winner") && name.includes("alliance")) bonus += 10;
                else if (["think", "connect", "innovate", "control", "motivate", "design"].some(k => name.includes(k))) bonus += 10;
                else if (name.includes("finalist") && name.includes("alliance")) bonus += 5;
            });
            return bonus;
        }

        function closeModal(e) { if(e.target.id === 'scout-modal') e.target.style.display='none'; }

        // --- PESTAÑAS ---
        function setTab(mode) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('t-'+mode).classList.add('active');
            document.getElementById('view-ev').style.display = mode === 'ev' ? 'block' : 'none';
            document.getElementById('view-tm').style.display = mode === 'tm' ? 'block' : 'none';
        }

        // --- CHATBOT ---
        async function send() {
            const inp = document.getElementById('chat-in');
            const txt = inp.value; if(!txt)return;
            const box = document.getElementById('chat-msgs');
            box.innerHTML += `<div class="user">${txt}</div>`; inp.value='';
            try {
                const r = await fetch('/api/nasa-rag', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_query:txt, lang:'es', mode:'ftc'})});
                const d = await r.json();
                box.innerHTML += `<div class="ai">${d.answer}</div>`;
            } catch(e) { box.innerHTML += `<div class="ai" style="color:red">Error.</div>`; }
            box.scrollTop=box.scrollHeight;
        }

        // --- GAME ---
        function initGame() {
            const g = document.getElementById('mines'); g.innerHTML='';
            for(let i=0; i<32; i++) {
                let d = document.createElement('div'); d.className='cell';
                let isMine = Math.random() < 0.15;
                d.onclick = () => { d.className = isMine ? 'cell trap' : 'cell safe'; if(!isMine) d.innerText='•'; };
                d.oncontextmenu = (e) => { e.preventDefault(); d.className='cell flag'; d.innerHTML='<i class="fas fa-flag"></i>'; };
                g.appendChild(d);
            }
        }
    </script>
</body>
</html>
